---
title: ğŸŒ™ MAGICï¼šä¸º Text2SQL ä»»åŠ¡è‡ªåŠ¨ç”Ÿæˆ self-correction guideline
author: Bin Yu
createTime: 2024/06/25 16:05:00
permalink: /arxiv/2406.12692/
---

> è®ºæ–‡ï¼š[MAGIC: Generating Self-Correction Guideline for In-Context Text-to-SQL](http://arxiv.org/abs/2406.12692)
>
> â­â­â­â­
>
> è±é¡¿å¤§å­¦ & Microsoft, arXiv:2406.12692

## ä¸€ã€è®ºæ–‡é€Ÿè¯»

DIN-SQL æ¨¡å‹ä¸­ä½¿ç”¨äº†ä¸€ä¸ª self-correction æ¨¡å—ï¼Œä»–æŠŠ LLM ç›´æ¥ç”Ÿæˆçš„ SQL å¸¦ä¸Šä¸€äº› guidelines çš„ promptï¼Œè®© LLM è¿›è¡Œè‡ªæˆ‘æ£€æŸ¥å¹¶æ”¹æ­£è¿™ä¸ªé”™è¯¯çš„ SQLã€‚ä½†æ˜¯è¿™é‡Œçš„ guidelines æ˜¯äººå·¥æ‰‹å†™çš„ï¼Œæ¯”å¦‚ä¸‹å›¾æ˜¯ DIN-SQL ä¸­çš„ self-correction guidelines çš„ promptï¼š

<center><img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/1717161441480.png" alt="1717161441480" style="zoom:75%;"></center>

è¿™ç¯‡è®ºæ–‡æå‡ºäº†ä¸€ä¸ªå¯ä»¥è‡ªåŠ¨ç”Ÿæˆ self-correction guidelines çš„æ–¹æ³•ï¼š<mark>MAGIC</mark>ã€‚

**ä»»åŠ¡å®šä¹‰**ï¼šç»™å®š user questionã€DB schema å’Œä¸€ä¸ªé”™è¯¯çš„ SQLï¼Œç”Ÿæˆä¸€ä¸ª self-correction guidelinesï¼Œå¯ä»¥ prompt LLM æ¥çº æ­£é”™è¯¯çš„ SQL ä»è€Œå¾—åˆ°çº æ­£æ­£ç¡®çš„ SQLã€‚è¿™ä¸ªä»»åŠ¡å°±æ˜¯æœ¬è®ºæ–‡éœ€è¦è§£å†³çš„ä»»åŠ¡â€”â€”<mark>self-correction guideline generation</mark> ä»»åŠ¡ã€‚

> è¾“å…¥ä¸­çš„é”™è¯¯çš„ SQL å°±æ˜¯åŸå…ˆç”± LLM ç”Ÿæˆçš„ SQL ä½†ä¸èƒ½æ­£ç¡®æ‰§è¡Œçš„ SQLã€‚

ä¸‹å›¾å°±æ˜¯ LLM ä½¿ç”¨ self-correction guidelines æ¥çº æ­£é”™è¯¯ SQL çš„ç¤ºä¾‹ï¼š

<center><img src="https://notebook-img-1304596351.cos.ap-beijing.myqcloud.com/img/20240625205622.png" alt="20240625205622" style="zoom:75%;"></center>

å¯ä»¥çœ‹åˆ°ï¼ŒLLM å¯ä»¥æ ¹æ® guidelines æ¥æ£€æŸ¥è¿™ä¸ªé”™è¯¯ SQLï¼Œæ‰¾å‡ºå…¶ä¸­çš„é—®é¢˜ä»è€Œå¾—åˆ°ä¿®æ­£åçš„æ­£ç¡® SQLã€‚

## äºŒã€MAGIC

å‡è®¾ä½¿ç”¨ $s'$ è¡¨ç¤º incorrect SQLï¼Œä½¿ç”¨ `s^{gt}` è¡¨ç¤º ground-truth SQLã€‚

MAGIC ç”± 3 ä¸ª agent ç»„æˆï¼šmanager agentã€feedback agent å’Œ correction agentã€‚

### 2.1 Feedback-correction cycle

ç»™å®šä¸€ä¸ª user questionã€$s^{gt}$ã€$s'$ï¼Œé‚£ manager agent å°±å¼€å§‹ä¸€ä¸ª feedback-correction cycleï¼Œå®ƒæ˜¯ä¸€ä¸ªè¿­ä»£çš„è¿‡ç¨‹ã€‚

åœ¨æ¯ä¸€ä¸ª iteration ä¸­ï¼š

- manager agent è¦æ±‚ feedback agent é€šè¿‡å¯¹æ¯” $s'$ å’Œ $s^{gt}$ æ¥ç”Ÿæˆä¸€ä¸ª **feedback** æ¥è§£é‡Š $s'$ ä¸­çš„é”™è¯¯
- ä¹‹åï¼Œmanager agent å°†æ¥æ”¶åˆ°çš„ feedback ç»™ correction agentï¼Œè¦æ±‚å®ƒæ ¹æ® feedback ä¿®æ­£ $s'$ ä»è€Œç”Ÿæˆä¸€ä¸ªæ–°çš„ **revised SQL**

é‡å¤è¿›è¡Œè¿­ä»£ï¼Œç›´åˆ° revised SQL æ­£ç¡®æˆ–è€…è¿­ä»£æ¬¡æ•°è¾¾åˆ°æœ€å¤§é™åˆ¶ã€‚

### 2.2 Revising agents' instruction

åˆšåˆš feedback-correction cycle æ˜¯è¯´äº† manager agent äº¤äº’çš„æµç¨‹æ¥ä¸æ–­ä¿®æ­£ SQLã€‚

è¿™é‡Œæ˜¯åœ¨è¯´ manager agent åœ¨äºå¦å¤–ä¸¤ä¸ª agent äº¤äº’æ—¶ï¼Œæ‰€ä½¿ç”¨çš„ prompt ä¹Ÿæ˜¯åœ¨ä¸æ–­è¢«ä¿®æ­£çš„ã€‚

åœ¨ feedback-correction cycle çš„ç¬¬ä¸€ä¸ª iteration ä¸­ï¼Œmanager agent ä½¿ç”¨äº†ä¸¤ä¸ª predefined prompts æ¥ä¸ feedback-agent å’Œ correction-agent åšçš„äº¤äº’ã€‚ä½†æ˜¯å¦‚æœä¸€æ¬¡ iteration å $s'$ ä»ç„¶æ²¡æœ‰è¢«ä¿®æ­£æ­£ç¡®ï¼Œé‚£ä¹ˆ manager agent ä¹Ÿè¦ä¿®æ­£è¿™äº› predefined promptsã€‚

é‚£ manager agent æ€ä¹ˆä¿®æ­£ prompts å‘¢ï¼Ÿâ€”â€” ä½¿ç”¨ä¸€ä¸ªä¸“é—¨è®¾è®¡çš„ prompt æ¥æç¤º LLM æ¥ä¿®æ­£ predefined promptsã€‚

### 2.3 Guideline generation

å½“ correction agent æ¯æ¬¡ä¿®æ­£æˆåŠŸä¸€ä¸ª SQL åï¼Œmanager agent ä¼šè®°ä¸‹æ¥è¿™ä¸€è½® iteration ä¸­ç”± feedback agent ç”Ÿæˆçš„ feedbackã€‚

> å› ä¸ºæ˜¯è¿™ä¸€ä¸ª feedback æ¥è®© correction agent ä¿®æ­£æ­£ç¡®çš„ï¼Œæ‰€ä»¥è¿™ä¸€ä¸ª feedback æ˜¯æŒ‡å‡ºäº† SQL é”™è¯¯çš„å…³é”®ï¼Œå› æ­¤è®© manager agent è®°ä¸‹æ¥ã€‚

æ¯ä¸ª data point ä¼šåœ¨ç»è¿‡ä¸€ä¸ª feedback-correction cycle åè®°å½•ä¸€ä¸ª feedback åˆ° memory ä¸­ï¼Œå½“ manager agent è®°å½•çš„ feedbacks ç´¯è®¡è¾¾åˆ° $k$ ä¸ªä¹‹åï¼Œä¼šå°†è¿™ä¸€ batch çš„ k ä¸ª feedbacks ä¸€åŒå½¢æˆä¸€ä¸ª self-correction guidelineã€‚

è¿™ä¸ª self-correction guideline ä¼šè¢«ç”¨äºä¹‹åçš„ Text2SQL çš„ self-correction è¿‡ç¨‹ä¸­ï¼Œç›´åˆ°åˆç´¯ç§¯åˆ° k ä¸ª feedbacks åé‡æ–°è§¦å‘ç”Ÿæˆä¸€ä¸ª self-correction guidelineã€‚

åˆ©ç”¨ k ä¸ª feedbacks æ¥ç”Ÿæˆ guideline çš„æ–¹æ³•ï¼Œå°±æ˜¯ä½¿ç”¨ä¸€ä¸ªä¸“é—¨çš„ prompt æ¥æç¤º LLM ç”Ÿæˆã€‚

åœ¨ç¬¬ä¸€ä¸ª batch ä¸­ï¼Œè¿˜æ²¡æœ‰å¯ç”¨çš„ guidelineï¼Œè¿™æ—¶ manager agent ä¼šå…ˆåˆå§‹åŒ–ä¸€ä¸ª guidelineï¼Œä¹‹åçš„æ¯ä¸ª batchï¼Œmanager agent ä¼šæ›´æ–°ç°åœ¨çš„ guidelineã€‚

## ä¸‰ã€æ‰€æœ‰ç”¨åˆ°çš„ prompts

è¿™é‡Œæ€»ç»“ä¸€ä¸‹æ•´ä¸ªæ–¹æ³•æ‰€ä½¿ç”¨çš„ promptsï¼š

- ä¸¤ä¸ª predefined promptsï¼šè¿™ä¸¤ä¸ª prompts ç”¨æ¥ä¸€å¼€å§‹æ—¶ manager agent ç”¨æ¥ä¸ feedback agent å’Œ correction agent è¿›è¡Œäº¤äº’ã€‚
- manager agent ç”¨æ¥ä¿®æ­£ predefined prompts çš„ä¸¤ä¸ª promptsï¼šä¸€ä¸ª prompt ç”¨æ¥è®© manager agent ä¿®æ­£ä¸ feedback agent äº¤äº’æ‰€ç”¨çš„ promptï¼Œä¸€ä¸ªæ˜¯ä¿®æ­£ä¸ correction agent çš„ã€‚
- manager agent ç”¨æ¥å°† k ä¸ª feedbacks ç”Ÿæˆå‡ºä¸€ä¸ª self-correction guideline çš„ promptã€‚

## å››ã€å®éªŒ

ä»¥å¾€çš„ DIN-SQL ä¸­å°±æœ‰ä¸€ä¸ª self-correction moduleï¼Œè¿™ä¸ªæ¨¡å—ä½¿ç”¨ä¸€ä¸ª guideline æ¥è®© LLM ä¿®æ­£é”™è¯¯çš„ SQLï¼Œä½†è¿™ä¸ªæ¨¡å‹ä¸­çš„ guideline æ˜¯äººå·¥è®¾è®¡çš„ã€‚è¿™ç¯‡è®ºæ–‡å°è¯•å°†è¿™ä¸ªæ¨¡å—çš„ guideline æ›´æ¢ä¸ºä½¿ç”¨æœ¬æ–‡æå‡ºçš„è‡ªåŠ¨ç”Ÿæˆçš„ guidelineï¼Œå‘ç°æ•´ä¸ª Text2SQL æ¨¡å‹çš„è¡¨ç°å¾—åˆ°äº†å¾ˆå¤§çš„æå‡ï¼Œä»è€Œè¯æ˜äº†æ–¹æ³•çš„æœ‰æ•ˆæ€§ã€‚

## äº”ã€æ€»ç»“

è¿™ç¯‡è®ºæ–‡ç€é‡æŒ‡å‡ºäº† in-context learning çš„ Text2SQL ä»»åŠ¡ä¸­ self-correction çš„æ–°é¢–è§†è§’ï¼Œå°†æå‡ Text2SQL ä¸­çš„ self-correction ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„ä»»åŠ¡ï¼Œå…‹æœäº†ä»¥å¾€æ–¹æ³•éœ€è¦æ‰‹å·¥è®¾è®¡ self-correction guideline çš„ç¼ºç‚¹ã€‚

åŒæ—¶ï¼Œè¿™ç¯‡è®ºæ–‡è¿˜è§£å†³äº†è‡ªåŠ¨ä¿®å¤äººç±»ç”Ÿæˆçš„é”™è¯¯ SQL çš„é‡è¦ä»»åŠ¡ï¼Œå±•ç¤ºäº† LLM è¿›è¡Œè‡ªæˆ‘æ ¡æ­£çš„èƒ½åŠ›ã€‚
