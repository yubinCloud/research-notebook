<!doctype html><html lang="zh-CN"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="generator" content="VuePress 2.0.0-rc.9" /><meta name="theme" content="VuePress Theme Plume 1.0.0-rc.55" /><script id="check-dark-mode">;(function () {const um= localStorage.getItem('vuepress-theme-appearance') || 'auto';const sm = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;if (um === 'dark' || (um !== 'light' && sm)) {document.documentElement.classList.add('dark');}})();</script><script id="check-mac-os">document.documentElement.classList.toggle('mac', /Mac|iPhone|iPod|iPad/i.test(navigator.platform))</script><title>🌙 CHESS：利用上下文来合成 SQL 的 pipeline</title><meta name="description" content=""><link rel="preload" href="/research-notebook/assets/style-Cec0e0LW.css" as="style"><link rel="stylesheet" href="/research-notebook/assets/style-Cec0e0LW.css"><link rel="modulepreload" href="/research-notebook/assets/app-s5JIphqh.js"><link rel="modulepreload" href="/research-notebook/assets/index.html-C9fq1LXw.js"><link rel="prefetch" href="/research-notebook/assets/index.html-B-j-ryWq.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-D4spU_9v.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-B0-1BBu1.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-SLLIY8d9.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-C65jmr_M.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-C-bL2yAS.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-C7B5e00U.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-Nt9kYeWR.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-CE_bMlSy.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-CLhUsc3g.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-DXgEbOI-.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-v1oOswjF.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-CBJ8xjXF.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-D4Fq4d_T.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-ByB-z2iB.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-Q9nU2u_y.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-D8yUAJ7Y.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-Dtno56yj.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-BDK4L6jX.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-Dc5x4woP.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-eGfCPn-9.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-D70LzGEm.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-BPemUoR7.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-BwgVpDih.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-DlaBYZPe.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-CgVNpCXw.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-G5FDBLuS.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-uDKSTe9v.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-BVMJJZGD.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-CrHd4gIE.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-BiSS2sK0.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-DXcBEjAg.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-CQoGuxuN.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-CRi0y6sX.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-BKNM53Nr.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-C0kRXJHb.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-QyJX4BVb.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-CJvsDrCW.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-BwT074si.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-sp3GJ4_Y.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-C3rZacVL.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-B0q2VZS4.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-CYDgqNcV.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-CDChQk7d.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-_hma_Fnn.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-7G48gGCA.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-BlT-qKyg.js" as="script"><link rel="prefetch" href="/research-notebook/assets/404.html-V2miJEAG.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-BcMo9zlU.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-CrhXs5dX.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-DEOpBtft.js" as="script"><link rel="prefetch" href="/research-notebook/assets/index.html-BKeLltu8.js" as="script"><link rel="prefetch" href="/research-notebook/assets/SearchBox-CGeHVkxs.js" as="script"></head><body><div id="app"><!--[--><div class="theme-plume" data-v-ba475dda><!--[--><!--[--><span tabindex="-1" data-v-4bbc90d0></span><a href="#LayoutContent" class="skip-link visually-hidden" data-v-4bbc90d0> Skip to content </a><!--]--><!----><div class="nav-wrapper" data-v-ba475dda data-v-7a402866><div class="navbar-wrapper" data-v-7a402866 data-v-c0f362fa><div class="container" data-v-c0f362fa><div class="title" data-v-c0f362fa><div class="navbar-title" data-v-c0f362fa data-v-b77839f9><a class="auto-link link title" href="/" data-v-b77839f9 data-v-5111f611><!--[--><!----> <!--]--><!----></a></div></div><div class="content" data-v-c0f362fa><div class="curtain" data-v-c0f362fa></div><div class="content-body" data-v-c0f362fa><div class="navbar-search search" data-v-c0f362fa><div class="search-wrapper" data-v-60fa285e><!----><div id="local-search" data-v-60fa285e><button type="button" class="mini-search mini-search-button" aria-label="搜索文档" data-v-60fa285e><span class="mini-search-button-container"><svg class="mini-search-search-icon" width="20" height="20" viewBox="0 0 20 20" aria-label="search icon"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="mini-search-button-placeholder">搜索文档</span></span><span class="mini-search-button-keys"><kbd class="mini-search-button-key"></kbd><kbd class="mini-search-button-key">K</kbd></span></button></div></div></div><nav aria-labelledby="main-nav-aria-label" class="navbar-menu menu" data-v-c0f362fa data-v-b0c203ca><span id="main-nav-aria-label" class="visually-hidden" data-v-b0c203ca>Main Navigation</span><!--[--><!--[--><a class="auto-link link navbar-menu-link" href="/category/LM/" data-v-b0c203ca data-v-c7242555 data-v-5111f611><!--[--><!----><i data-v-c7242555>LLM</i><!--]--><!----></a><!--]--><!--[--><a class="auto-link link navbar-menu-link" href="/category/LLM-evaluation/" data-v-b0c203ca data-v-c7242555 data-v-5111f611><!--[--><!----><i data-v-c7242555>LLM 评估</i><!--]--><!----></a><!--]--><!--[--><a class="auto-link link navbar-menu-link" href="/category/RAG/" data-v-b0c203ca data-v-c7242555 data-v-5111f611><!--[--><!----><i data-v-c7242555>RAG</i><!--]--><!----></a><!--]--><!--[--><a class="auto-link link navbar-menu-link" href="/category/Text2SQL/" data-v-b0c203ca data-v-c7242555 data-v-5111f611><!--[--><!----><i data-v-c7242555>Text2SQL</i><!--]--><!----></a><!--]--><!--]--></nav><!----><div class="navbar-appearance appearance" data-v-c0f362fa data-v-376ec936><button class="switch-wrapper switch-appearance" type="button" role="switch" aria-label="toggle dark mode" aria-checked="false" data-v-376ec936 data-v-b27b6603 data-v-f90faf21><span class="check" data-v-f90faf21><span class="icon" data-v-f90faf21><!--[--><span class="vpi-sun sun" data-v-b27b6603></span><span class="vpi-moon moon" data-v-b27b6603></span><!--]--></span></span></button></div><!----><div class="flyout-wrapper navbar-extra extra" data-v-c0f362fa data-v-7914c0f6 data-v-7e56bc7a><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-7e56bc7a><span class="vpi-more-horizontal icon" data-v-7e56bc7a></span></button><div class="menu" data-v-7e56bc7a><div class="menu-wrapper" data-v-7e56bc7a data-v-b4fba565><!----><!--[--><!--[--><!----><div class="group" data-v-7914c0f6><div class="item appearance" data-v-7914c0f6><p class="label" data-v-7914c0f6>外观</p><div class="appearance-action" data-v-7914c0f6><button class="switch-wrapper switch-appearance" type="button" role="switch" aria-label="toggle dark mode" aria-checked="false" data-v-7914c0f6 data-v-b27b6603 data-v-f90faf21><span class="check" data-v-f90faf21><span class="icon" data-v-f90faf21><!--[--><span class="vpi-sun sun" data-v-b27b6603></span><span class="vpi-moon moon" data-v-b27b6603></span><!--]--></span></span></button></div></div></div><!----><!--]--><!--]--></div></div></div><button type="button" class="navbar-hamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="nav-screen" data-v-c0f362fa data-v-7e5802de><span class="container" data-v-7e5802de><span class="top" data-v-7e5802de></span><span class="middle" data-v-7e5802de></span><span class="bottom" data-v-7e5802de></span></span></button></div></div></div></div><!----></div><!----><!----><div id="LayoutContent" class="layout-content" data-v-ba475dda data-v-094016f3><!--[--><div class="has-aside plume-page" data-v-5b0e3d8f><div class="container" data-v-5b0e3d8f><div class="aside" data-v-5b0e3d8f><div class="aside-container" data-v-5b0e3d8f><div class="aside-content" data-v-5b0e3d8f><div class="page-aside" data-v-5b0e3d8f data-v-f8c78049><div class="has-outline page-aside-outline" data-v-f8c78049><div class="content" data-v-f8c78049><div class="outline-marker" data-v-f8c78049></div><div class="outline-title" data-v-f8c78049><span data-v-f8c78049>此页内容</span><span class="vpi-print icon" data-v-f8c78049></span></div><nav aria-labelledby="doc-outline-aria-label" data-v-f8c78049><span id="doc-outline-aria-label" class="visually-hidden" data-v-f8c78049> Table of Contents for current page </span><ul class="root" data-v-f8c78049 data-v-9a83b7a1><!--[--><li data-v-9a83b7a1><a class="outline-link" href="#一、论文速读" data-v-9a83b7a1>一、论文速读</a><!----></li><li data-v-9a83b7a1><a class="outline-link" href="#二、chess-pipeline" data-v-9a83b7a1>二、CHESS pipeline</a><ul class="nested" data-v-9a83b7a1 data-v-9a83b7a1><!--[--><li data-v-9a83b7a1><a class="outline-link" href="#_2-1-entity-and-context-retrieval" data-v-9a83b7a1>2.1 Entity and Context Retrieval</a><!----></li><li data-v-9a83b7a1><a class="outline-link" href="#_2-2-schema-selection" data-v-9a83b7a1>2.2 Schema Selection</a><!----></li><li data-v-9a83b7a1><a class="outline-link" href="#_2-3-query-generation" data-v-9a83b7a1>2.3 Query Generation</a><!----></li><!--]--></ul></li><li data-v-9a83b7a1><a class="outline-link" href="#三、预处理" data-v-9a83b7a1>三、预处理</a><!----></li><li data-v-9a83b7a1><a class="outline-link" href="#四、实验" data-v-9a83b7a1>四、实验</a><!----></li><li data-v-9a83b7a1><a class="outline-link" href="#五、总结讨论" data-v-9a83b7a1>五、总结讨论</a><!----></li><!--]--></ul></nav></div></div></div></div></div></div><div class="content" data-v-5b0e3d8f><div class="content-container" data-v-5b0e3d8f><!--[--><!----><h1 class="page-title" data-v-dbc950ba>🌙 CHESS：利用上下文来合成 SQL 的 pipeline</h1><div class="page-meta-wrapper" data-v-dbc950ba><p class="author" data-v-dbc950ba><span class="icon vpi-user" data-v-dbc950ba></span><span data-v-dbc950ba>Bin Yu</span></p><p class="reading-time" data-v-dbc950ba><span class="vpi-books icon" data-v-dbc950ba></span><span data-v-dbc950ba>1372字</span><span data-v-dbc950ba>约5分钟</span></p><!----><p class="create-time" data-v-dbc950ba><span class="vpi-clock icon" data-v-dbc950ba></span><span data-v-dbc950ba>2024-06-11</span></p></div><!--]--><!--[--><div style="position:relative;" data-v-5b0e3d8f><div class="plume-content" data-v-5b0e3d8f><blockquote><p>论文：<a href="http://arxiv.org/abs/2405.16755" target="_blank" rel="noopener noreferrer">CHESS: Contextual Harnessing for Efficient SQL Synthesis<span class="vpi-external-link external-icon" data-v-9f412e4e></span></a></p><p>⭐⭐⭐⭐</p><p>Stanford, arXiv:2405.16755</p></blockquote><h2 id="一、论文速读" tabindex="-1"><a class="header-anchor" href="#一、论文速读"><span>一、论文速读</span></a></h2><p>本文提出了一个 pipeline 框架——CHESS——来解决应用于复杂的真实数据库场景下的 Text2SQL 问题。</p><p>在现实场景下，数据库 schema 通常包含不明确的 column name、table name 和混乱的数据，这都对 SQL 转换问题提出了挑战，因此<strong>需要一个健壮的检索系统来识别出其中相关的信息</strong>。下图展示了一个在做 Text2SQL 时会面临的挑战：</p><!----><ul><li>1）用户问题可能没有确切的数据库值</li><li>2）column name 可能不能很好的表示这一列存储了什么数据，因此需要 database catalogs 信息来辅助</li><li>3）对于一个 question，有多种 SQL 写法</li></ul><p><strong>在以往的研究中，大多将 SQL 生成的上下文限制为 table schema、column 定义和 sample rows，但在生产级数据库中，db catelog、db value 也是重要的辅助信息</strong>。</p><p>本文提出了 <mark>CHESS</mark>，一个针对现实世界的复杂 DB 的 Text2SQL 系统，它引入了一个 scalable、effective 的 LLM-based 的 pipeline 用于 SQL 生成，主要由三个组件构成：<strong>entity and context retrieval、schema selection、SQL generation</strong>。</p><h2 id="二、chess-pipeline" tabindex="-1"><a class="header-anchor" href="#二、chess-pipeline"><span>二、CHESS pipeline</span></a></h2><p>CHESS 整个 pipeline 执行的流程如下图所示，共由三个模块组成：</p><!----><p>这个流程中有一个需要解决的关键问题是：<strong>由于 LLM 上下文窗口的限制，无法将 DB 所有信息都传给 LLM，但 context 又不能缺失有关信息，因此过滤出有用的 DB 信息是需要特别关注的</strong>。</p><h3 id="_2-1-entity-and-context-retrieval" tabindex="-1"><a class="header-anchor" href="#_2-1-entity-and-context-retrieval"><span>2.1 Entity and Context Retrieval</span></a></h3><p><strong>这个 module 需要将 user question 中提及到的相关 entity 和 db schema 提取出来，用于后序步骤的输入</strong>。这个过程分成 3 步：</p><ul><li><strong>Keyword Extraction</strong>：这一步是从 NL 中提取出 keywords，使用的方法就是 prompt + few-shots ICL 来让 LLM 提取出 keywords、keyphrases、named entities。</li><li><strong>Entity Retrieval</strong>：在得到 keyword list 后，我们从数据库中检索相似的值，并为每个 keyword 返回相关的 db cell value，以及对应的 column。这里的检索方法采用了局部敏感哈希（LSH）和 semantic embedding similarity 检索的<strong>分层检索策略</strong>，从而高效地检索出与 keyword 语法和语义都相似的 cell value。</li><li><strong>Context Retrieval</strong>：除了 db cell value，数据库中的 catelogs 包含了解释 db schema 的可用信息（比如注释），这一步使用 vector db 来检索与 keyword 最相似的描述信息。</li></ul><h3 id="_2-2-schema-selection" tabindex="-1"><a class="header-anchor" href="#_2-2-schema-selection"><span>2.2 Schema Selection</span></a></h3><p><strong>这个 module 是缩小 schema 的范围，使之只包含生成 SQL 时必要的 tables 和 columns</strong>。这种过滤后的 schema 称为 <em>efficient schema</em>。这里分为如下步骤：</p><ul><li><strong>Individual Column Filtering</strong>：这一步是筛选掉 db 中不相关的 columns，只将最相关的 columns 传递给表选择步骤。实现方式上，是将每个 column 与 question 的相关性视为一个二分类任务，本质上是询问 LLM 该列是否可能与 question 有关。注意，这一步只对移除明显不相关的 columns 有用，之后会再次过滤。</li><li><strong>Table Selection</strong>：过滤掉不相关的 columns 之后，这一步继续选择必需的 tables。实现方式是，将前一步过滤的 schema 交给 LLM 来评估 table 与 question 的相关性，并只选择与 SQL 查询所需要的 tables。</li><li><strong>Final Column Selection</strong>：从选择出的 tables 中再次过滤 columns，将 schema 减少到生成 SQL 所需的最小列集。实现方式是，prompt LLM 让它评估每一 column 的必要性，包含它的 Chain-of-Thought 的解释。</li></ul><h3 id="_2-3-query-generation" tabindex="-1"><a class="header-anchor" href="#_2-3-query-generation"><span>2.3 Query Generation</span></a></h3><p>前面的步骤已经选出了一个上下文增强的 efficient schema，其中包含了创建 SQL 所需的所有必要信息。下面的步骤中，就是先生成一个候选 SQL，然后对此 SQL 执行并让 LLM 修复其中的语义和语法错误。</p><ul><li><strong>Candidate Generation</strong>：通过 prompt LLM 让它生成一个候选 SQL</li><li><strong>Revision</strong>：基于 context 和候选 SQL 的执行结果，要求 model 评估 SQL 查询的正确性，并在必要时对其进行修改。具体实现时，可能会给他一套 rules，同时使用 self-consistency 等技巧。</li></ul><h2 id="三、预处理" tabindex="-1"><a class="header-anchor" href="#三、预处理"><span>三、预处理</span></a></h2><p>在 CHESS pipeline 中，需要使用 LSH 算法检索和 vector db 检索，因此需要一个预处理过程来为数据库构建检索索引。</p><h2 id="四、实验" tabindex="-1"><a class="header-anchor" href="#四、实验"><span>四、实验</span></a></h2><p>论文主要在 BIRD 和 Spider 上做了实验，LLM 选择了多种类型进行了对比。</p><p>下图是 CHESS 与现有方法的对比：</p><!----><ul><li>红色是 CHESS 框架并使用专用模型，蓝色是使用了开源通用模型</li></ul><h2 id="五、总结讨论" tabindex="-1"><a class="header-anchor" href="#五、总结讨论"><span>五、总结讨论</span></a></h2><p>CHESS pipeline 在 BIRD 和 Spider 数据集上都取得了不错的表现。此外，CHESS 还开发了一个完全开源的版本，可以私有部署，且在 BIRD 上执行准确率超过 60%，缩小了闭源和开源 LLM 的性能差距，同时保证了<strong>企业数据隐私</strong>。</p><p>但对于 BIRD 数据集，目前的模型仍然不如人类写 SQL 的表现，未来的工作应该旨在进一步缩小这个差距。</p><p>此外，设计更高精度的 schema selection 方法是未来研究的一个高影响领域，可以对准确性产生巨大影响。</p></div><!----></div><footer class="page-footer" data-v-5b0e3d8f data-v-bb1af879><!----><div class="contributors" data-v-bb1af879><span class="contributors-label" data-v-bb1af879>贡献者: </span><span class="contributors-info" data-v-bb1af879><!--[--><!--[--><span class="contributor" title="email: yubin_SkyWalker@yeah.net" data-v-bb1af879>yubinCloud</span><!----><!--]--><!--]--></span></div><!----></footer><!----><!--]--></div></div></div></div><button style="display:none;" type="button" class="back-to-top-button" aria-label="back to top" data-v-ba475dda data-v-b42999a2><span class="percent" data-v-b42999a2>0%</span><span class="show icon vpi-back-to-top" data-v-b42999a2></span><svg aria-hidden="true" data-v-b42999a2><circle cx="50%" cy="50%" style="stroke-dasharray:calc(0% - 12.566370614359172px) calc(314.1592653589793% - 12.566370614359172px);" data-v-b42999a2></circle></svg></button><footer class="plume-footer" data-v-ba475dda data-v-46d530a6><div class="container" data-v-46d530a6><p class="message" data-v-46d530a6>Power by <a target="_blank" href="https://v2.vuepress.vuejs.org/">VuePress</a> & <a target="_blank" href="https://github.com/pengzhanbo/vuepress-theme-plume">vuepress-theme-plume</a></p><!----></div></footer><!--]--></div><!--]--></div><!--[--><!--]--><!--]--></div><script type="module" src="/research-notebook/assets/app-s5JIphqh.js" defer></script></body></html>